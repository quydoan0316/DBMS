<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Search Patients with Images</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  input, button { padding: 5px; margin: 5px; }
  .patient { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
  .patient h3 { margin: 0 0 10px 0; }

  .folder { margin: 10px 0 10px 20px; }
  .folder h4 { margin: 0; cursor: pointer; color: #007bff; font-size: 16px; }

  .image-meta { 
    display: flex; 
    align-items: flex-start; 
    margin: 10px 0 15px 20px;
  }

  .image-meta img { 
    max-width: 800px;
    margin-right: 20px; 
    border: 1px solid #ddd;
    border-radius: 5px;
  }

  .metadata { 
    font-size: 14px; 
    background: #f9f9f9; 
    padding: 10px; 
    border-radius: 5px;
    flex: 1;
  }

  .pagination { margin-top: 20px; }
</style>
</head>
<body>

<h1>Search Patients</h1>
<input type="text" id="keyword" placeholder="Enter keyword">
<input type="number" id="pageSize" value="1" min="1" style="width: 60px;">
<button onclick="startSearch()">Search</button>

<div id="results"></div>
<div class="pagination">
  <button onclick="prevPage()">Previous</button>
  <span id="pageInfo">Page 1</span>
  <button onclick="nextPage()">Next</button>
</div>

<script>
let currentPage = 1;
let pageSize = 1;
let currentKeyword = "";

// =============== Äá»‡ quy render thÆ° má»¥c ===============
function renderFolder(folderData, folderName) {
    const folderDiv = document.createElement("div");
    folderDiv.className = "folder";

    const header = document.createElement("h4");
    header.textContent = `ðŸ“‚ ${folderName}`;
    folderDiv.appendChild(header);

    const contentDiv = document.createElement("div");
    contentDiv.style.display = "none"; // áº©n máº·c Ä‘á»‹nh

    // kiá»ƒm tra náº¿u folderData lÃ  máº£ng (=> danh sÃ¡ch áº£nh)
    if (Array.isArray(folderData)) {
        folderData.forEach(imgObj => {
            const wrapper = document.createElement("div");
            wrapper.className = "image-meta";

            const img = document.createElement("img");
            img.src = `data:image/png;base64,${imgObj.image_base64}`;
            wrapper.appendChild(img);

            const metaDiv = document.createElement("div");
            metaDiv.className = "metadata";
            let metaHtml = "<b>Metadata:</b><br>";
            for (const [key, value] of Object.entries(imgObj.metadata)) {
                metaHtml += `${key}: ${value}<br>`;
            }
            metaHtml += `<br><b>Filename:</b> ${imgObj.filename}`;
            metaDiv.innerHTML = metaHtml;

            wrapper.appendChild(metaDiv);
            contentDiv.appendChild(wrapper);
        });
    } else {
        // ngÆ°á»£c láº¡i lÃ  object => thÆ° má»¥c con
        for (const [subFolderName, subFolderData] of Object.entries(folderData)) {
            contentDiv.appendChild(renderFolder(subFolderData, subFolderName));
        }
    }

    // toggle má»Ÿ/Ä‘Ã³ng
    header.addEventListener("click", () => {
        contentDiv.style.display = contentDiv.style.display === "none" ? "block" : "none";
    });

    folderDiv.appendChild(contentDiv);
    return folderDiv;
}

// =============== Fetch Data ===============
async function fetchData() {
    const url = `http://127.0.0.1:8000/search_keyword_with_images?keyword=${encodeURIComponent(currentKeyword)}&page=${currentPage}&page_size=${pageSize}`;
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "Loading...";

    try {
        const res = await fetch(url);
        if (!res.ok) {
            const errText = await res.text();
            resultsDiv.innerHTML = `Error: ${errText}`;
            return;
        }

        const data = await res.json();
        resultsDiv.innerHTML = "";

        if (!data.patients || data.patients.length === 0) {
            resultsDiv.innerHTML = "No results found.";
            return;
        }

        data.patients.forEach(patient => {
            const div = document.createElement("div");
            div.className = "patient";

            div.innerHTML = `
                <h3>Patient: ${patient.patient_id}</h3>
                <p><b>Diagnosis:</b> ${patient.diagnosis}</p>
                <p><b>Regimen:</b> ${patient.regimen}</p>
            `;

            for (const [folderName, folderData] of Object.entries(patient.folders)) {
                div.appendChild(renderFolder(folderData, folderName));
            }

            resultsDiv.appendChild(div);
        });

        document.getElementById("pageInfo").innerText = `Page ${data.page}`;
    } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = "Error fetching data.";
    }
}

function startSearch() {
    currentKeyword = document.getElementById("keyword").value;
    pageSize = document.getElementById("pageSize").value;
    currentPage = 1;
    fetchData();
}

function nextPage() {
    currentPage++;
    fetchData();
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        fetchData();
    }
}
</script>

</body>
</html>
